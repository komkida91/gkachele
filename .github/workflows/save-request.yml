name: Guardar solicitud de cliente

on:
  workflow_dispatch:
    inputs:
      nombre_cliente:
        description: "Nombre del cliente"
        required: true
        type: string
      slug:
        description: "Identificador opcional"
        required: false
        type: string
      rubro:
        description: "Rubro del negocio"
        required: true
        type: choice
        options:
          - restaurante
          - danza
          - cosmeticos
          - politica
          - fitness
          - educacion
          - base
      plan:
        description: "Plan solicitado"
        required: true
        type: choice
        options:
          - base
          - pro
          - premium
      redes:
        description: "Redes sociales o enlaces relevantes"
        required: false
        type: string
      timestamp:
        description: "Fecha de creaciÃ³n (ISO 8601)"
        required: false
        type: string
      payload:
        description: "Datos completos de la solicitud (JSON)"
        required: false
        type: string

jobs:
  save-request:
    name: Guardar solicitud
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      INPUT_NOMBRE_CLIENTE: ${{ github.event.inputs.nombre_cliente }}
      INPUT_SLUG: ${{ github.event.inputs.slug }}
      INPUT_RUBRO: ${{ github.event.inputs.rubro }}
      INPUT_PLAN: ${{ github.event.inputs.plan }}
      INPUT_REDES: ${{ github.event.inputs.redes }}
      INPUT_TIMESTAMP: ${{ github.event.inputs.timestamp }}
      INPUT_PAYLOAD: ${{ github.event.inputs.payload }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ADMIN_TOKEN }}

      - name: Preparar archivo de solicitudes
        run: |
          mkdir -p data
          if [ ! -f data/requests.json ]; then
            echo "[]" > data/requests.json
          fi

      - name: Agregar entrada
        run: |
          node <<'NODE'
          const fs = require('fs');
          const path = 'data/requests.json';

          let content;
          try {
            content = fs.readFileSync(path, 'utf8');
          } catch (error) {
            content = '[]';
          }

          let entries;
          try {
            entries = JSON.parse(content || '[]');
            if (!Array.isArray(entries)) entries = [];
          } catch (error) {
            entries = [];
          }

          const sanitize = (value) => (value ? value.toString().trim() : '');
          const slugify = (value) => {
            const base = sanitize(value);
            if (!base) return '';
            return base
              .normalize('NFD')
              .replace(/[\u0300-\u036f]/g, '')
              .toLowerCase()
              .replace(/[^a-z0-9-]+/g, '-')
              .replace(/-{2,}/g, '-')
              .replace(/^-+|-+$/g, '');
          };

          let payload = {};
          try {
            payload = process.env.INPUT_PAYLOAD ? JSON.parse(process.env.INPUT_PAYLOAD) : {};
          } catch (error) {
            payload = {};
          }

          let redes = payload.redes_sociales || {};
          if ((!redes || Object.keys(redes).length === 0) && process.env.INPUT_REDES) {
            try {
              redes = JSON.parse(process.env.INPUT_REDES);
            } catch (error) {
              redes = { resumen: process.env.INPUT_REDES };
            }
          }

          const baseNombre = sanitize(process.env.INPUT_NOMBRE_CLIENTE) || sanitize(payload?.cliente?.nombre_completo) || 'Sitio';
          let slug = sanitize(process.env.INPUT_SLUG) || sanitize(payload.slug);
          if (!slug) slug = slugify(baseNombre) || `sitio-${Date.now()}`;

          payload.slug = slug;

          const entry = {
            nombre_cliente: baseNombre,
            slug,
            rubro: sanitize(process.env.INPUT_RUBRO) || sanitize(payload?.cliente?.rubro),
            plan: sanitize(process.env.INPUT_PLAN) || sanitize(payload.plan),
            contacto: {
              email: sanitize(payload?.cliente?.email) || null,
              telefono: sanitize(payload?.cliente?.telefono) || null
            },
            personalizacion: payload.personalizacion || {},
            redes_sociales: redes,
            direccion: payload.direccion || {},
            rubro_especifico: payload.rubro_especifico || null,
            descripcion: sanitize(payload.descripcion),
            dominio: payload.dominio || {},
            payload,
            estado: 'pendiente',
            created_at: sanitize(process.env.INPUT_TIMESTAMP) || payload.fecha_creacion || new Date().toISOString()
          };

          entries.push(entry);
          fs.writeFileSync(path, JSON.stringify(entries, null, 2));
          NODE

      - name: Commit y push
        run: |
          git config user.name "GKACHELE Bot"
          git config user.email "actions@users.noreply.github.com"
          git add data/requests.json
          if git diff --cached --quiet; then
            echo "No hay cambios que guardar"
            exit 0
          fi
          git commit -m "Registrar solicitud de ${INPUT_NOMBRE_CLIENTE}" --no-verify
          git push

