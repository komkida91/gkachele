name: Monitoreo y Limpieza (Cron)

on:
  schedule:
    # Ejecutar cada hora
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: read
  pages: write

jobs:
  monitoreo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Monitorear sitios
        run: |
          echo "üìä MONITOREO DE SITIOS"
          echo "======================"
          echo ""
          
          # Lista de sitios a monitorear
          SITIOS=(
            "https://gkachele.duckdns.org"
            "https://blowdance.duckdns.org"
            "https://dalmau-intendente.duckdns.org"
          )
          
          # Contador de sitios online
          ONLINE=0
          TOTAL=${#SITIOS[@]}
          
          echo "üîç Verificando $TOTAL sitios..."
          echo ""
          
          for SITIO in "${SITIOS[@]}"; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$SITIO" || echo "000")
            
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
              echo "‚úÖ $SITIO - Online (HTTP $HTTP_CODE)"
              ONLINE=$((ONLINE + 1))
            else
              echo "‚ùå $SITIO - Offline (HTTP $HTTP_CODE)"
            fi
          done
          
          echo ""
          echo "üìä RESULTADOS:"
          echo "   Total sitios: $TOTAL"
          echo "   Online: $ONLINE"
          echo "   Offline: $((TOTAL - ONLINE))"
          echo "   Uptime: $(( (ONLINE * 100) / TOTAL ))%"
          
          # Guardar m√©tricas (para uso futuro en dashboard)
          echo "{
            \"total\": $TOTAL,
            \"online\": $ONLINE,
            \"offline\": $((TOTAL - ONLINE)),
            \"uptime\": $(( (ONLINE * 100) / TOTAL )),
            \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
          }" > metrics.json
          
          # Commit m√©tricas si hay cambios
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          if [ -n "$(git status --porcelain metrics.json)" ]; then
            git add metrics.json
            git commit -m "üìä Actualizar m√©tricas de monitoreo - $(date +%Y-%m-%d\ %H:%M)" || true
            git push origin main || true
          fi
      
      - name: Limpiar cache de GitHub Pages
        run: |
          echo "üßπ LIMPIEZA DE CACHE"
          echo "===================="
          echo ""
          echo "üìã Cache de GitHub Pages se limpia autom√°ticamente en cada deploy"
          echo "   - Cada push a main limpia el cache"
          echo "   - Los workflows de deploy limpian autom√°ticamente"
          echo ""
          echo "‚úÖ Cache limpio"
      
      - name: Verificar conexiones
        run: |
          echo "üîå VERIFICAR CONEXIONES"
          echo "======================"
          echo ""
          
          # Verificar conexi√≥n a DuckDNS
          echo "üì° Verificando DuckDNS..."
          if curl -s --max-time 5 "https://www.duckdns.org/" > /dev/null; then
            echo "‚úÖ DuckDNS accesible"
          else
            echo "‚ö†Ô∏è DuckDNS no responde"
          fi
          
          # Verificar GitHub Pages
          echo "üì° Verificando GitHub Pages..."
          if curl -s --max-time 5 "https://github.com" > /dev/null; then
            echo "‚úÖ GitHub accesible"
          else
            echo "‚ö†Ô∏è GitHub no responde"
          fi
          
          echo ""
          echo "‚úÖ Verificaci√≥n completada"

