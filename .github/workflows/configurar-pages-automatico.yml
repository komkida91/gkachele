name: Configurar GitHub Pages Autom√°ticamente

on:
  push:
    branches:
      - main
    paths:
      - 'CNAME'
      - '.github/workflows/configurar-pages-automatico.yml'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  configurar-pages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Configurar GitHub Pages
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO_NAME="${{ github.repository }}"
          REPO_OWNER=$(echo $REPO_NAME | cut -d'/' -f1)
          REPO_REPO=$(echo $REPO_NAME | cut -d'/' -f2)
          
          echo "üîß Configurando Pages para: $REPO_REPO"
          
          # Leer CNAME del repositorio
          if [ -f "CNAME" ]; then
            CNAME_DOMAIN=$(cat CNAME | tr -d '\n\r ' | head -1)
            echo "üìÑ CNAME encontrado en repo: $CNAME_DOMAIN"
          else
            echo "‚ö†Ô∏è  No se encontr√≥ archivo CNAME"
            CNAME_DOMAIN=""
          fi
          
          # Paso 1: Verificar si Pages est√° habilitado
          echo "üîç Verificando estado de Pages..."
          PAGES_STATUS=$(gh api "repos/$REPO_OWNER/$REPO_REPO/pages" 2>/dev/null || echo "{}")
          
          # Paso 2: Configurar Pages para usar GitHub Actions SIN CNAME
          echo "üöÄ Configurando Pages para GitHub Actions (sin CNAME)..."
          
          # M√©todo 1: Intentar POST con build_type workflow Y cname vac√≠o
          echo "   üìù M√©todo 1: Intentando crear Pages con GitHub Actions..."
          if gh api "repos/$REPO_OWNER/$REPO_REPO/pages" \
            -X POST \
            -f build_type=workflow \
            -f cname='' \
            2>/dev/null; then
            echo "   ‚úÖ Pages creado: build_type=workflow, cname=vac√≠o"
          # M√©todo 2: Intentar PUT con build_type workflow Y cname vac√≠o
          elif gh api "repos/$REPO_OWNER/$REPO_REPO/pages" \
            -X PUT \
            -f build_type=workflow \
            -f cname='' \
            2>/dev/null; then
            echo "   ‚úÖ Pages actualizado: build_type=workflow, cname=vac√≠o"
          # M√©todo 3: Si Pages existe pero est√° configurado con branch, cambiar a workflow
          elif echo "$PAGES_STATUS" | grep -q '"build_type"'; then
            echo "   üìù Pages existe con otra configuraci√≥n, cambiando a workflow..."
            # Primero eliminar CNAME si existe
            gh api "repos/$REPO_OWNER/$REPO_REPO/pages" \
              -X PUT \
              -f cname='' \
              2>/dev/null || true
            # Luego cambiar build_type a workflow
            gh api "repos/$REPO_OWNER/$REPO_REPO/pages" \
              -X PUT \
              -f build_type=workflow \
              -f cname='' \
              2>/dev/null && echo "   ‚úÖ Pages configurado: build_type=workflow, cname=vac√≠o" || echo "   ‚ö†Ô∏è  Error al cambiar configuraci√≥n"
          else
            echo "   ‚ö†Ô∏è  No se pudo configurar Pages autom√°ticamente"
            echo "   üìù Pages debe habilitarse manualmente primero:"
            echo "      https://github.com/$REPO_OWNER/$REPO_REPO/settings/pages"
            echo "      ‚Üí Build and deployment: 'GitHub Actions'"
            echo "      ‚Üí Custom domain: DEJAR VAC√çO"
          fi
          
          # Paso 3: Verificar y forzar que CNAME est√© vac√≠o
          echo "üóëÔ∏è  Verificando que CNAME est√© vac√≠o..."
          sleep 2  # Esperar un poco para que GitHub procese
          
          PAGES_FINAL=$(gh api "repos/$REPO_OWNER/$REPO_REPO/pages" 2>/dev/null || echo "{}")
          CNAME_FINAL=$(echo "$PAGES_FINAL" | grep -o '"cname":"[^"]*"' | cut -d'"' -f4 || echo "")
          
          if [ -n "$CNAME_FINAL" ] && [ "$CNAME_FINAL" != "null" ] && [ "$CNAME_FINAL" != "" ]; then
            echo "   ‚ö†Ô∏è  CNAME todav√≠a tiene valor: $CNAME_FINAL"
            echo "   üîÑ Eliminando CNAME..."
            gh api "repos/$REPO_OWNER/$REPO_REPO/pages" \
              -X PUT \
              -f cname='' \
              2>/dev/null && echo "   ‚úÖ CNAME eliminado" || echo "   ‚ö†Ô∏è  Error al eliminar CNAME"
          else
            echo "   ‚úÖ CNAME ya est√° vac√≠o"
          fi
          
          echo ""
          echo "‚úÖ Configuraci√≥n completada:"
          echo "   - Build type: workflow (GitHub Actions)"
          echo "   - CNAME en Settings: VAC√çO (no redirige github.io)"
          if [ -n "$CNAME_DOMAIN" ]; then
            echo "   - CNAME en repo: $CNAME_DOMAIN (para DuckDNS)"
          fi
          echo ""
          echo "‚ö†Ô∏è  IMPORTANTE: DuckDNS funcionar√° por el archivo CNAME en el repo"
          echo "   github.io NO funcionar√° ni redirigir√° porque CNAME no est√° en Settings"
      
      - name: Verificar configuraci√≥n
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO_NAME="${{ github.repository }}"
          REPO_OWNER=$(echo $REPO_NAME | cut -d'/' -f1)
          REPO_REPO=$(echo $REPO_NAME | cut -d'/' -f2)
          
          echo "üîç Verificando configuraci√≥n..."
          gh api "repos/$REPO_OWNER/$REPO_REPO/pages" \
            --jq '{build_type, cname, status}'

