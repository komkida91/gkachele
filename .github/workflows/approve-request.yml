name: Approve or Cancel Request

on:
  workflow_dispatch:
    inputs:
      action:
        required: true
        type: string
        description: "Acci√≥n a ejecutar (approve_request o cancel_request)"
      payload:
        required: false
        type: string
        description: "JSON con datos adicionales (slug, nombre, rubro, plan, redes)"

permissions:
  contents: write

jobs:
  handle:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          ref: dev
          token: ${{ secrets.ADMIN_TOKEN }}

      - name: Instalar dependencias
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Preparar datos del payload
        id: datos
        run: |
          payload='${{ github.event.inputs.payload }}'
          if [ -z "$payload" ] || [ "$payload" = "null" ]; then
            payload='{"slug":"demo-site","nombre":"Cliente Demo","rubro":"base","plan":"base","redes":{}}'
          fi

          echo "$payload" > payload.json
          slug=$(jq -r '.slug // "demo-site"' payload.json)
          nombre=$(jq -r '.nombre // "Cliente Demo"' payload.json)
          rubro=$(jq -r '.rubro // "base"' payload.json)
          plan=$(jq -r '.plan // "base"' payload.json)
          redes=$(jq -c '.redes // {}' payload.json)

          echo "slug=$slug" >> "$GITHUB_OUTPUT"
          echo "nombre=$nombre" >> "$GITHUB_OUTPUT"
          echo "rubro=$rubro" >> "$GITHUB_OUTPUT"
          echo "plan=$plan" >> "$GITHUB_OUTPUT"
          echo "redes=$redes" >> "$GITHUB_OUTPUT"

      - name: Ejecutar create-site.sh
        if: ${{ github.event.inputs.action == 'approve_request' }}
        env:
          SLUG: ${{ steps.datos.outputs.slug }}
          NOMBRE: ${{ steps.datos.outputs.nombre }}
          RUBRO: ${{ steps.datos.outputs.rubro }}
          PLAN: ${{ steps.datos.outputs.plan }}
          REDES: ${{ steps.datos.outputs.redes }}
          PAYLOAD_JSON: ${{ github.event.inputs.payload }}
        run: |
          echo "Aprobando solicitud para $NOMBRE ($SLUG)..."
          chmod +x core/scripts/create-site.sh
          core/scripts/create-site.sh "$SLUG" "$NOMBRE" "$RUBRO" "$PLAN" "$REDES"

      - name: Crear repositorio y publicar en Pages
        if: ${{ github.event.inputs.action == 'approve_request' }}
        env:
          GH_TOKEN: ${{ secrets.ADMIN_TOKEN }}
          OWNER: komkida91
          SLUG: ${{ steps.datos.outputs.slug }}
          NOMBRE: ${{ steps.datos.outputs.nombre }}
          RUBRO: ${{ steps.datos.outputs.rubro }}
          PLAN: ${{ steps.datos.outputs.plan }}
          RAW_PAYLOAD: ${{ github.event.inputs.payload }}
        run: |
          set -euo pipefail

          REPO_NAME="$SLUG"
          DESCRIPTION="Sitio de $NOMBRE - $RUBRO ($PLAN) generado autom√°ticamente"

          echo "üîç Verificando si existe el repositorio $OWNER/$REPO_NAME..."
          if ! gh repo view "$OWNER/$REPO_NAME" >/dev/null 2>&1; then
            echo "üÜï Creando repositorio p√∫blico $OWNER/$REPO_NAME"
            gh repo create "$OWNER/$REPO_NAME" --public --description "$DESCRIPTION" --confirm
          else
            echo "‚ÑπÔ∏è  El repositorio ya existe. Se sobrescribir√° el contenido."
          fi

          SITE_DIR="proyectos/$SLUG"
          if [ ! -d "$SITE_DIR" ]; then
            echo "‚ùå Carpeta $SITE_DIR no encontrada. Abortando."
            exit 1
          fi

          pushd "$SITE_DIR" >/dev/null
          git init
          git config user.name "GKACHELE Bot"
          git config user.email "actions@users.noreply.github.com"
          git add .
          if git diff --cached --quiet; then
            echo "‚ö†Ô∏è  No hay cambios para publicar."
          else
            git commit -m "Publicaci√≥n inicial del sitio $NOMBRE"
          fi
          git branch -M main
          git remote add origin "https://$OWNER:${GH_TOKEN}@github.com/$OWNER/$REPO_NAME.git" || git remote set-url origin "https://$OWNER:${GH_TOKEN}@github.com/$OWNER/$REPO_NAME.git"
          git push --force origin main
          popd >/dev/null

          echo "‚öôÔ∏è  Configurando GitHub Pages"
          gh api -X PUT "repos/$OWNER/$REPO_NAME/pages" -f source[branch]=main -f source[path]=/

          if [ -n "${RAW_PAYLOAD:-}" ] && [ "${RAW_PAYLOAD}" != "null" ]; then
            DOMAIN=$(echo "$RAW_PAYLOAD" | jq -r '.dominio.preferido // empty')
            if [ -n "$DOMAIN" ]; then
              echo "üìõ Configurando dominio personalizado: $DOMAIN"
              gh api -X PUT "repos/$OWNER/$REPO_NAME/pages" -F source[branch]=main -F source[path]=/ -F cname="$DOMAIN" || true
            fi
          fi

      - name: Registrar cancelaci√≥n
        if: ${{ github.event.inputs.action == 'cancel_request' }}
        run: |
          echo "Cancelando solicitud (sin acciones adicionales)."

      - name: Actualizar solicitudes
        if: ${{ github.event.inputs.action == 'approve_request' || github.event.inputs.action == 'cancel_request' }}
        env:
          ACTION: ${{ github.event.inputs.action }}
          SLUG: ${{ steps.datos.outputs.slug }}
        run: |
          set -euo pipefail
          echo "üßπ Removiendo solicitud $SLUG de data/requests.json"
          tmp_file=$(mktemp)
          jq --arg slug "$SLUG" 'map(select(.slug != $slug))' data/requests.json > "$tmp_file"
          mv "$tmp_file" data/requests.json

          git config user.name "GKACHELE Bot"
          git config user.email "actions@users.noreply.github.com"
          git add data/requests.json

          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è  data/requests.json ya estaba limpio."
            exit 0
          fi

          git commit -m "Actualizar solicitudes tras ${ACTION} de $SLUG"
          git push origin HEAD:dev

